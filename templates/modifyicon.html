<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{url_for('static', filename='modifyicon.css')}}"
    />
    <title>Modify icon</title>
  </head>

  <body>
    <button data-i18n="return" onclick="window.location.href = '/control_menu'">
      Return
    </button>
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="icon" accept="image/*" />

      <select name="name" id="shortcutSelect" required>
        <option data-i18n="select-shortcut" value="">Select shortcut</option>
      </select>

      <label data-i18n="select-icon">Select icon</label>
      <div id="iconPicker"></div>

      <input type="hidden" id="iconSelectValue" name="iconSelect" />

      <button data-i18n="apply" class="submit">Apply</button>
    </form>

    <script type="module">
      import {
        update_lang,
        change_lang,
      } from "{{ url_for('static', filename='lang.js')}}";

      async function loadShortcuts() {
        const res = await fetch("/settings/list_shortcuts");
        const data = await res.json();
        if (data.status === "success") {
          const select = document.getElementById("shortcutSelect");
          for (const name of Object.keys(data.shortcuts)) {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
          }
        }
      }

      async function loadIcons() {
        const picker = document.getElementById("iconPicker");
        picker.innerHTML = "";
        const addIconGroup = async (url, title) => {
          const res = await fetch(url);
          const data = await res.json();
          if (data.status === "success" && data.icons.length > 0) {
            const groupTitle = document.createElement("div");
            groupTitle.textContent = title;
            groupTitle.style.margin = "10px 0 5px";
            groupTitle.style.fontWeight = "bold";
            picker.appendChild(groupTitle);

            data.icons.forEach((icon) => {
              const img = document.createElement("img");
              img.src = url.includes("default")
                ? `static/images/defaults/${icon}`
                : `static/images/user_uploaded/${icon}`;
              img.alt = icon;
              img.title = icon;
              img.style.width = "60px";
              img.style.height = "60px";
              img.style.margin = "5px";
              img.style.cursor = "pointer";
              img.style.border = "2px solid transparent";
              img.style.borderRadius = "10px";

              img.onclick = () => {
                document
                  .querySelectorAll("#iconPicker img")
                  .forEach((i) => (i.style.border = "2px solid transparent"));
                img.style.border = "2px solid #007BFF";
                document.getElementById("iconSelectValue").value = icon;
              };

              picker.appendChild(img);
            });
          }
        };

        await addIconGroup("/list_default_icons", "Defaults icons");
        await addIconGroup("/list_icons", "Custom icons");
      }

      document.getElementById("uploadForm").onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        const res = await fetch("/upload_icon", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        if (data.status === "success") {
          alert("Icon updated");
          loadIcons();
        } else {
          alert("Error : " + data.message);
        }
      };

      loadShortcuts();
      loadIcons();
    </script>
    <script
      src="{{ url_for('static', filename='lang.js')}}"
      type="module"
    ></script>
  </body>
</html>
